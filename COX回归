
# 1.0 COX回归(ukb_train_set)----
# 导入必要的包
library(dplyr)
library(survival)
library(broom)

# 1. 读取数据
selected_metabolites_file <- "selected_ukbmetabolites_set.csv"

# 读取代谢物文件
selected_metabolites <- read.csv(selected_metabolites_file, header = TRUE)

# 2. 提取所需列
# 提取代谢物列

# 提取协变量的列名
metabolite_columns <- as.character(selected_metabolites[, 1])
covariate_columns <- c(names(ukb_train_set)[2:10], names(ukb_train_set)[34:37])

# 提取随访时间和结局变量的列名
time_var <- names(ukb_train_set)[14]
outcome_var <- names(ukb_train_set)[19]

# 创建一个空的列表，用于存储每个代谢物的回归分析结果
cox_results <- list()

# 3. 逐个进行COX回归分析并保存结果
for (metabolite in metabolite_columns) {
  formula <- as.formula(paste("Surv(", time_var, ", ", outcome_var, ") ~ ", metabolite, " + ", paste(covariate_columns, collapse = " + ")))
  cox_model <- coxph(formula, data = ukb_train_set)
  cox_summary <- tidy(cox_model, conf.int = TRUE)
  cox_summary <- cox_summary %>% filter(term == metabolite)  # 只保留代谢物相关的结果
  cox_summary$metabolite <- metabolite  # 添加代谢物列
  
  # 计算代谢物的均值和标准差
  cox_summary$Mean <- mean(ukb_train_set[[metabolite]], na.rm = TRUE)
  cox_summary$SD <- sd(ukb_train_set[[metabolite]], na.rm = TRUE)
  
  # 进行Schoenfeld残差检验
  test_ph <- cox.zph(cox_model)
  test_ph_result <- as.data.frame(test_ph$table)
  
  # 过滤出与当前代谢物相关的行
  test_ph_result <- test_ph_result[rownames(test_ph_result) == metabolite,]
  
  # 添加检验统计量和p值
  cox_summary$chisq <- test_ph_result$chisq
  cox_summary$p_value_ph <- test_ph_result$p
  
  cox_results[[metabolite]] <- cox_summary
}

# 将结果合并为一个数据框
results_df <- bind_rows(cox_results)

# 计算HR及95%CI
results_df <- results_df %>%
  mutate(
    HR = exp(estimate),
    CI_lower = exp(conf.low),
    CI_upper = exp(conf.high)
  )

# 进行FDR校正
results_df$p.adjust <- p.adjust(results_df$p.value, method = "fdr")

# 选取需要的列，并按FDR校正后的P值排序
results_df <- results_df %>%
  select(metabolite, Mean, SD, estimate, std.error, HR, CI_lower, CI_upper, p.value, p.adjust, chisq, p_value_ph) %>%
  arrange(p.adjust)

# 将结果保存到CSV文件
write.csv(results_df, "cox_trainset_results.csv", row.names = FALSE)

# 提示用户任务完成
cat("COX回归分析结果已保存到文件 cox_trainset_results.csv 中。\n")













